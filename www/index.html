<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Mask My Text</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="theme-color" content="#000000" />
    <meta
      name="description"
      content="Text masking application with WebAssembly support"
    />
    <link rel="manifest" href="/manifest.json" />
    <link
      rel="icon"
      type="image/png"
      sizes="192x192"
      href="/icons/icon-192x192.png"
    />
    <link rel="apple-touch-icon" href="/icons/icon-192x192.png" />
    <style>
      :root {
        --primary-color: #2563eb;
        --bg-color: #f8fafc;
        --text-color: #1e293b;
        --border-color: #e2e8f0;
        --button-hover: #1d4ed8;
      }

      [data-theme="dark"] {
        --primary-color: #60a5fa;
        --bg-color: #0f172a;
        --text-color: #e2e8f0;
        --border-color: #1e293b;
        --button-hover: #3b82f6;
      }

      * {
        box-sizing: border-box;
        margin: 0;
        padding: 0;
      }

      body {
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto,
          Oxygen, Ubuntu, Cantarell, "Open Sans", "Helvetica Neue", sans-serif;
        line-height: 1.6;
        background-color: var(--bg-color);
        color: var(--text-color);
        min-height: 100vh;
        transition: background-color 0.3s, color 0.3s;
      }

      .container {
        max-width: 1200px;
        margin: 0 auto;
        padding: 2rem;
      }

      header {
        text-align: center;
        margin-bottom: 2rem;
        position: relative;
      }

      .settings-container {
        position: absolute;
        right: 0;
        top: 0;
        display: flex;
        gap: 0.5rem;
      }

      .settings-popup {
        display: none;
        position: absolute;
        right: 0;
        top: 100%;
        margin-top: 0.5rem;
        background: var(--bg-color);
        border: 1px solid var(--border-color);
        border-radius: 0.5rem;
        padding: 1rem;
        min-width: 200px;
        box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1),
          0 2px 4px -1px rgba(0, 0, 0, 0.06);
        z-index: 100;
      }

      .settings-popup.show {
        display: block;
      }

      .settings-popup h3 {
        font-size: 1rem;
        margin-bottom: 1rem;
        color: var(--text-color);
      }

      .settings-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 0.5rem 0;
        border-bottom: 1px solid var(--border-color);
      }

      .settings-item:last-child {
        border-bottom: none;
      }

      .settings-label {
        font-size: 0.875rem;
        color: var(--text-color);
      }

      .settings-info {
        font-size: 0.75rem;
        color: var(--text-color);
        opacity: 0.7;
        margin-top: 0.25rem;
      }

      .theme-toggle {
        position: absolute;
        right: 0;
        top: 0;
        background: none;
        border: 1px solid var(--border-color);
        color: var(--text-color);
        padding: 0.5rem;
        border-radius: 0.375rem;
        cursor: pointer;
        display: flex;
        align-items: center;
        gap: 0.5rem;
      }

      .theme-toggle:hover {
        background: var(--border-color);
      }

      h1 {
        color: var(--primary-color);
        font-size: 2.5rem;
        margin-bottom: 0.5rem;
      }

      .content {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 2rem;
      }

      .text-box {
        background: var(--bg-color);
        border: 1px solid var(--border-color);
        border-radius: 0.5rem;
        padding: 1rem;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
      }

      .text-box-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 1rem;
      }

      .text-box h2 {
        font-size: 1.25rem;
        color: var(--text-color);
      }

      .char-count {
        font-size: 0.875rem;
        color: var(--text-color);
        opacity: 0.8;
      }

      .button-group {
        display: flex;
        gap: 0.5rem;
        margin-top: 1rem;
      }

      .button {
        padding: 0.5rem 1rem;
        border-radius: 0.375rem;
        cursor: pointer;
        font-size: 0.875rem;
        display: flex;
        align-items: center;
        gap: 0.5rem;
        border: none;
      }

      .button-primary {
        background: var(--primary-color);
        color: white;
      }

      .button-primary:hover {
        background: var(--button-hover);
      }

      .button-danger {
        background: #ef4444;
        color: white;
      }

      .button-danger:hover {
        background: #dc2626;
      }

      .button-secondary {
        background: transparent;
        border: 1px solid var(--border-color);
        color: var(--text-color);
      }

      .button-secondary:hover {
        background: var(--border-color);
      }

      textarea {
        width: 100%;
        height: 300px;
        padding: 1rem;
        border: 1px solid var(--border-color);
        border-radius: 0.375rem;
        font-size: 1rem;
        line-height: 1.5;
        resize: vertical;
        background: var(--bg-color);
        color: var(--text-color);
      }

      #output {
        white-space: pre-wrap;
        height: 300px;
        overflow-y: auto;
        background: var(--bg-color);
        padding: 1rem;
        border-radius: 0.375rem;
        border: 1px solid var(--border-color);
      }

      @media (max-width: 768px) {
        .content {
          grid-template-columns: 1fr;
        }

        .container {
          padding: 1rem;
        }

        .settings-container {
          position: static;
          justify-content: center;
          margin: 1rem 0;
        }

        .settings-popup {
          position: fixed;
          top: 50%;
          left: 50%;
          transform: translate(-50%, -50%);
          margin: 0;
          width: 90%;
          max-width: 300px;
        }
      }

      .mask-words-section {
        margin-bottom: 2rem;
        background: var(--bg-color);
        border: 1px solid var(--border-color);
        border-radius: 0.5rem;
        padding: 1.5rem;
      }

      .mask-words-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 1rem;
      }

      .mask-words-controls {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-top: 1rem;
      }

      .mask-words-input {
        width: 100%;
        padding: 0.75rem;
        border: 1px solid var(--border-color);
        border-radius: 0.375rem;
        font-size: 1rem;
        background: var(--bg-color);
        color: var(--text-color);
      }

      .mask-words-input::placeholder {
        color: var(--text-color);
        opacity: 0.6;
      }

      .mask-words-help {
        font-size: 0.875rem;
        color: var(--text-color);
        opacity: 0.8;
        margin-top: 0.5rem;
      }

      .word-chips-container {
        display: flex;
        flex-wrap: wrap;
        gap: 0.5rem;
        margin-top: 1rem;
        min-height: 2rem;
      }

      .word-chip {
        background: var(--primary-color);
        color: white;
        padding: 0.25rem 0.75rem;
        border-radius: 1rem;
        font-size: 0.875rem;
        display: flex;
        align-items: center;
        gap: 0.5rem;
      }

      .word-chip button {
        background: none;
        border: none;
        color: white;
        cursor: pointer;
        padding: 0;
        font-size: 1rem;
        line-height: 1;
        display: flex;
        align-items: center;
      }
    </style>
  </head>
  <body>
    <noscript
      >This page contains webassembly and javascript content, please enable
      javascript in your browser.</noscript
    >
    <div class="container">
      <header>
        <div class="settings-container">
          <button class="button button-secondary" id="theme-toggle">
            üåô Dark Mode
          </button>
          <button class="button button-secondary" id="settings-btn">
            ‚öôÔ∏è Settings
          </button>
          <div class="settings-popup" id="settings-popup">
            <h3>Settings</h3>
            <div class="settings-item">
              <div>
                <div class="settings-label">Clear Saved Data</div>
                <div class="settings-info">
                  Remove all saved words and preferences
                </div>
              </div>
              <button class="button button-danger" id="clear-data-btn">
                Clear Data
              </button>
            </div>
          </div>
        </div>
        <h1>Mask My Text</h1>
        <p>
          Enter your text on the left and see the masked result on the right
        </p>
      </header>

      <section class="mask-words-section">
        <div class="mask-words-header">
          <h2>Words to Mask</h2>
        </div>
        <input
          type="text"
          id="mask-words-input"
          class="mask-words-input"
          placeholder="Type a word and press Enter to add it to the mask list"
        />
        <p class="mask-words-help">
          These words will be specifically masked in your text
        </p>
        <div id="word-chips" class="word-chips-container"></div>
        <div class="mask-words-controls">
          <span id="words-count" class="char-count">0 words</span>
          <button class="button button-danger" id="clear-words-btn">
            üóëÔ∏è Clear Word List
          </button>
        </div>
      </section>

      <main class="content">
        <div class="text-box">
          <div class="text-box-header">
            <h2>Input Text</h2>
            <span class="char-count" id="char-count">0 characters</span>
          </div>
          <textarea
            id="input"
            placeholder="Type or paste your text here..."
          ></textarea>
          <div class="button-group">
            <button class="button button-danger" id="clear-btn">
              üóëÔ∏è Clear Text
            </button>
          </div>
        </div>
        <div class="text-box">
          <div class="text-box-header">
            <h2>Masked Output</h2>
          </div>
          <div id="output"></div>
          <div class="button-group">
            <button class="button button-primary" id="copy-btn">
              üìã Copy Masked Text
            </button>
          </div>
        </div>
      </main>
    </div>
    <script src="./bootstrap.js"></script>
    <script>
      if ("serviceWorker" in navigator) {
        window.addEventListener("load", () => {
          navigator.serviceWorker
            .register("/service-worker.js")
            .then((registration) => {
              console.log("ServiceWorker registration successful");
            })
            .catch((err) => {
              console.log("ServiceWorker registration failed: ", err);
            });
        });
      }

      // DOM Elements
      const inputTextarea = document.getElementById("input");
      const outputDiv = document.getElementById("output");
      const charCount = document.getElementById("char-count");
      const clearBtn = document.getElementById("clear-btn");
      const copyBtn = document.getElementById("copy-btn");
      const themeToggle = document.getElementById("theme-toggle");
      const maskWordsInput = document.getElementById("mask-words-input");
      const wordChipsContainer = document.getElementById("word-chips");
      const clearWordsBtn = document.getElementById("clear-words-btn");
      const wordsCount = document.getElementById("words-count");
      const settingsBtn = document.getElementById("settings-btn");
      const settingsPopup = document.getElementById("settings-popup");
      const clearDataBtn = document.getElementById("clear-data-btn");

      // Store mask words
      let maskWords = new Set();

      // Load saved words from localStorage
      function loadSavedWords() {
        const savedWords = localStorage.getItem("maskWords");
        if (savedWords) {
          maskWords = new Set(JSON.parse(savedWords));
          renderWordChips();
          updateWordsCount();
        }
      }

      // Save words to localStorage
      function saveWords() {
        localStorage.setItem("maskWords", JSON.stringify([...maskWords]));
      }

      // Load saved words on page load
      loadSavedWords();

      // Dark mode functionality
      const theme = localStorage.getItem("theme") || "light";
      document.documentElement.setAttribute("data-theme", theme);
      themeToggle.textContent =
        theme === "dark" ? "‚òÄÔ∏è Light Mode" : "üåô Dark Mode";

      themeToggle.addEventListener("click", () => {
        const currentTheme =
          document.documentElement.getAttribute("data-theme");
        const newTheme = currentTheme === "dark" ? "light" : "dark";
        document.documentElement.setAttribute("data-theme", newTheme);
        localStorage.setItem("theme", newTheme);
        themeToggle.textContent =
          newTheme === "dark" ? "‚òÄÔ∏è Light Mode" : "üåô Dark Mode";
      });

      // Handle adding mask words
      maskWordsInput.addEventListener("keydown", (e) => {
        if (e.key === "Enter" && maskWordsInput.value.trim()) {
          const input = maskWordsInput.value.trim();
          // Split by comma and process each word
          const wordsToAdd = input
            .split(",")
            .map((word) => word.trim())
            .filter((word) => word.length > 0);

          // Remove duplicates from the input array itself first
          const uniqueWordsToAdd = [...new Set(wordsToAdd)];

          let addedCount = 0;
          uniqueWordsToAdd.forEach((word) => {
            if (!maskWords.has(word)) {
              maskWords.add(word);
              addWordChip(word);
              addedCount++;
            }
          });

          if (addedCount > 0) {
            maskWordsInput.value = "";
            updateMaskedText();
            updateWordsCount();
            saveWords(); // Save after adding words
          }
        }
      });

      function updateWordsCount() {
        const count = maskWords.size;
        wordsCount.textContent = `${count} word${count !== 1 ? "s" : ""}`;
      }

      // Create and add word chip
      function addWordChip(word) {
        const chip = document.createElement("div");
        chip.className = "word-chip";
        chip.innerHTML = `
          ${word}
          <button onclick="removeWord('${word}')" title="Remove word">√ó</button>
        `;
        wordChipsContainer.appendChild(chip);
      }

      // Remove word from mask list
      function removeWord(word) {
        maskWords.delete(word);
        updateMaskedText();
        renderWordChips();
        updateWordsCount();
        saveWords(); // Save after removing word
      }

      // Render all word chips
      function renderWordChips() {
        wordChipsContainer.innerHTML = "";
        maskWords.forEach((word) => addWordChip(word));
      }

      // Update masked text
      function updateMaskedText() {
        const text = inputTextarea.value;
        try {
          const maskedText = maskText(text, maskWords);
          outputDiv.textContent = maskedText;
        } catch (error) {
          console.error("Error masking text:", error);
          outputDiv.textContent =
            "An error occurred while masking text. Check console for details.";
        }
      }

      // Update input event to use the masking function
      inputTextarea.addEventListener("input", (e) => {
        const text = e.target.value;
        charCount.textContent = `${text.length} characters`;
        updateMaskedText();
      });

      // Clear words list
      clearWordsBtn.addEventListener("click", () => {
        maskWords.clear();
        wordChipsContainer.innerHTML = "";
        updateMaskedText();
        updateWordsCount();
        saveWords(); // Save after clearing list
      });

      // Update clear button to only clear text
      clearBtn.addEventListener("click", () => {
        inputTextarea.value = "";
        outputDiv.textContent = "";
        charCount.textContent = "0 characters";
      });

      // Copy functionality
      copyBtn.addEventListener("click", async () => {
        try {
          await navigator.clipboard.writeText(outputDiv.textContent);
          const originalText = copyBtn.textContent;
          copyBtn.textContent = "‚úÖ Copied!";
          setTimeout(() => {
            copyBtn.textContent = originalText;
          }, 2000);
        } catch (err) {
          console.error("Failed to copy text:", err);
          copyBtn.textContent = "‚ùå Failed to copy";
          setTimeout(() => {
            copyBtn.textContent = originalText;
          }, 2000);
        }
      });

      // Settings popup toggle
      settingsBtn.addEventListener("click", (e) => {
        e.stopPropagation();
        settingsPopup.classList.toggle("show");
      });

      // Close settings popup when clicking outside
      document.addEventListener("click", (e) => {
        if (
          !settingsPopup.contains(e.target) &&
          !settingsBtn.contains(e.target)
        ) {
          settingsPopup.classList.remove("show");
        }
      });

      // Clear all saved data
      clearDataBtn.addEventListener("click", () => {
        // Clear mask words
        maskWords.clear();
        wordChipsContainer.innerHTML = "";
        updateWordsCount();
        updateMaskedText();
        localStorage.removeItem("maskWords");

        // Clear theme preference
        localStorage.removeItem("theme");
        document.documentElement.setAttribute("data-theme", "light");
        themeToggle.textContent = "üåô Dark Mode";

        // Close settings popup
        settingsPopup.classList.remove("show");

        // Show feedback
        const originalText = clearDataBtn.textContent;
        clearDataBtn.textContent = "‚úì Cleared";
        setTimeout(() => {
          clearDataBtn.textContent = originalText;
        }, 2000);
      });
    </script>
  </body>
</html>
